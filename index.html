<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>村瀨亮介のリアルタイム健康診断</title>
    <style>
        /* --- 基本設定とカラーパレット --- */
        :root {
            --light-bg: #f5f5f7;
            --light-card-bg: #ffffff;
            --light-text: #1d1d1f;
            --light-text-sub: #86868b;
            --light-border: #e5e5e5;
            --dark-bg: #121212;
            --dark-card-bg: #1e1e1e;
            --dark-text: #e0e0e0;
            --dark-text-sub: #a0a0a0;
            --dark-border: #333333;
            --ecg-alive-color: rgba(46, 204, 113, 0.4);
            --ecg-lost-color: rgba(48, 209, 201, 0.4);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2em;
            transition: background-color 0.5s, color 0.5s;
            /* overflow: hidden; をここから削除 */
        }

        /* --- ライト/ダークモード (CSS継承を利用) --- */
        body.light-mode { background-color: var(--light-bg); color: var(--light-text); }
        body.dark-mode { background-color: var(--dark-bg); color: var(--dark-text); }
        .light-mode .container { background-color: var(--light-card-bg); }
        .dark-mode .container { background-color: var(--dark-card-bg); }
        .light-mode h2, .light-mode #liveness-header { border-bottom-color: var(--light-border); }
        .dark-mode h2, .dark-mode #liveness-header { border-bottom-color: var(--dark-border); }
        .light-mode .timestamp { color: var(--light-text-sub); }
        .dark-mode .timestamp { color: var(--dark-text-sub); }
        .dark-mode #liveness-subtext a { color: #0a84ff; }
        .dark-mode .profile-image { filter: invert(1) grayscale(1); }

        /* --- レイアウト --- */
        .wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: calc(100vh - 4em);
        }
        .main-content {
            display: flex;
            width: 100%;
            max-width: 1200px;
            max-height: 800px;
        }

        /* --- PC/タブレット表示 (横長) --- */
        @media (min-aspect-ratio: 1/1) {
            body {
                overflow: hidden; /* 横長の時だけスクロールを禁止 */
            }
            .profile-container {
                flex: 0 0 40%;
                padding-right: 2em;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .profile-image {
                width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
                object-fit: cover;
                border-radius: 12px;
                transition: filter 0.5s;
            }
            .details-container { flex: 1; overflow-y: auto; min-height: 0; }
        }

        /* --- スマホ表示 (縦長) --- */
        @media (max-aspect-ratio: 1/1) {
            .profile-container { display: none; }
            .details-container {
                width: 100%;
                max-width: 600px;
                margin: 0 auto;
                height: 100%;
                overflow-y: auto;
            }
        }
        
        .container {
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .details-content { flex-grow: 1; }

        /* --- UI要素のスタイル --- */
        #liveness-header { text-align: center; padding-bottom: 1em; margin-bottom: 1em; border-bottom: 2px solid; }
        #liveness-message { font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: bold; }
        #liveness-subtext { font-size: clamp(0.9rem, 2vw, 1rem); margin-top: 0.5rem; min-height: 1.2em; }
        
        .timestamp {
            font-size: 0.8em;
            text-align: right;
            margin-top: 1em;
            padding-top: 1em;
        }

        h2 { border-bottom-width: 2px; border-bottom-style: solid; padding-bottom: 0.5em; white-space: nowrap; }
        .status { margin-bottom: 1.2em; font-size: 1.1em; }
        .label {
            font-weight: 600;
            display: inline-block;
            width: 120px;
            white-space: nowrap;
        }

        /* --- 心電図アニメーション --- */
        #ecg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }
    </style>
</head>
<body class="light-mode">
    
    <canvas id="ecg-canvas"></canvas>

    <div class="wrapper">
        <div class="main-content">
            <div class="profile-container">
                <img src="ogp.png" alt="プロフィール画像" class="profile-image">
            </div>

            <div class="details-container">
                <div class="container">
                    
                    <div id="liveness-header">
                        <div id="liveness-message">---</div>
                        <div id="liveness-subtext"></div>
                    </div>

                    <div class="details-content">
                        <h2><span>❤️ ヘルスケア</span></h2>
                        <div class="status"><span class="label">❤️ 心拍数:</span> <span id="heart_rate">---</span> bpm</div>
                        <div class="status"><span class="label">👟 歩数:</span> <span id="steps">---</span> 歩</div>
                        <div class="status"><span class="label">🔥 カロリー:</span> <span id="calories">---</span> kcal</div>
                        <div class="status"><span class="label">🩺 体調:</span> <span id="condition">---</span></div>
                        <div class="status"><span class="label">☀️ 起床時間:</span> <span id="wakeup_time">---</span></div>

                        <h2><span>📍 ロケーション</span></h2>
                        <div class="status"><span class="label">📍 現在地:</span> <span id="location">---</span></div>
                        
                        <h2><span>📱 デバイス</span></h2>
                        <div class="status"><span class="label">🔋 バッテリー:</span> <span id="device_status">---</span></div>
                    </div>

                    <div class="timestamp">最終更新: <span id="last_updated">---</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定項目 ---
        const gistId = '1f81b107b898201a865a613c319d579b'; 
        const gistFileName = 'murase_status.json';

        // --- 心電図アニメーション ---
        const canvas = document.getElementById('ecg-canvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        let x = 0, y = height / 2, heartRateBPM = 60, lastBeatTime = 0;

        function drawEcg() {
            const beatInterval = 60000 / heartRateBPM;
            const now = Date.now();
            ctx.clearRect(x, 0, 10, height);
            ctx.beginPath();
            ctx.moveTo(x - 2, y);
            
            let newY = height / 2;
            const amplitude = height * 0.25;
            
            if (now - lastBeatTime > beatInterval) {
                lastBeatTime = now;
                newY = height / 2 - amplitude;
            } else if (now - lastBeatTime < 50) {
                newY = height / 2 + (amplitude * 0.2);
            } else if (now - lastBeatTime > beatInterval - 200) {
                 newY = height / 2 + (amplitude * 0.4);
            }

            y = y * 0.9 + newY * 0.1;
            ctx.lineTo(x, y);
            ctx.strokeStyle = document.body.classList.contains('dark-mode') ? 'var(--ecg-lost-color)' : 'var(--ecg-alive-color)';
            ctx.lineWidth = 2;
            ctx.stroke();

            x = (x + 1) % width;
            if (x === 0) ctx.clearRect(0,0,width,height);
            
            requestAnimationFrame(drawEcg);
        }

        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            x = 0; y = height / 2;
        });

        // Gistから最新ステータスを取得してページに反映するメイン関数
        async function updateStatus() {
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`);
                const gist = await response.json();
                if (!response.ok || !gist.files || !gist.files[gistFileName]) {
                    throw new Error('Gist data is not available.');
                }
                const content = JSON.parse(gist.files[gistFileName].content);

                const lastUpdated = new Date(content.last_updated);
                const diffHours = (new Date() - lastUpdated) / (1000 * 60 * 60);
                
                const livenessMessageEl = document.getElementById('liveness-message');
                const livenessSubtextEl = document.getElementById('liveness-subtext');

                if (diffHours > 13) {
                    document.body.className = 'dark-mode';
                    livenessMessageEl.textContent = '村瀨亮介からの応答がありません。';
                    livenessSubtextEl.innerHTML = `安否確認は <a href="https://twitter.com/vl_lvo0" target="_blank" rel="noopener noreferrer">X(旧Twitter)@vl_lvo0</a> へ`;
                } else {
                    document.body.className = 'light-mode';
                    livenessMessageEl.textContent = '村瀨亮介は生きています。';
                    livenessSubtextEl.textContent = '';
                }

                document.getElementById('last_updated').textContent = lastUpdated.toLocaleString('ja-JP', { dateStyle: 'medium', timeStyle: 'short' });
                
                const currentHeartRate = parseInt(content.health.heart_rate, 10);
                document.getElementById('heart_rate').textContent = currentHeartRate || 'N/A';
                if(currentHeartRate) heartRateBPM = currentHeartRate;

                document.getElementById('steps').textContent = content.health.steps || 'N/A';
                document.getElementById('calories').textContent = content.health.active_calories ? Math.round(content.health.active_calories) : 'N/A';
                document.getElementById('location').textContent = content.location.city || 'N/A';
                
                const deviceStatus = `${content.device.battery}% ${content.device.is_charging === true ? '⚡️ 充電中' : ''}`;
                document.getElementById('device_status').textContent = deviceStatus;
                
                if (content.health.wakeup_time) {
                    const wakeupDate = new Date(content.health.wakeup_time);
                    document.getElementById('wakeup_time').textContent = wakeupDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                }

                const hrv = parseFloat(content.health.condition_hrv);
                const conditionEl = document.getElementById('condition');
                if (hrv > 50) { conditionEl.textContent = '良好 ✅'; conditionEl.style.color = 'green'; }
                else if (hrv > 30) { conditionEl.textContent = '普通 😐'; conditionEl.style.color = 'orange'; }
                else if (hrv) { conditionEl.textContent = '要注意 ⚠️'; conditionEl.style.color = 'red'; }
                else { conditionEl.textContent = 'N/A'; }

            } catch (error) {
                console.error('Failed to update status:', error);
                document.getElementById('liveness-message').textContent = 'データの取得に失敗しました。';
            }
        }

        // --- 関数の実行 ---
        drawEcg();
        updateStatus();

    </script>
</body>
</html>
