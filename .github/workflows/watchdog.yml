name: Watchdog Monitor

on:
  schedule:
    # 1æ™‚é–“ã«1å›ã€æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
    - cron: '0 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚‚æœ‰åŠ¹åŒ–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check Vital Status & Notify
        env:
          # --- Configuration ---
          GIST_ID: "1f81b107b898201a865a613c319d579b"
          FILE_NAME: "murase_status.json"
          
          # Thresholds (ç›£è¦–é–¾å€¤)
          WARN_HOURS: 71      # ç®¡ç†è€…ã¸ã®äºˆå‚™é€šçŸ¥ (ntfy)
          CRITICAL_HOURS: 72  # å…¨ä½“ã¸ã®æœ¬é€šçŸ¥ (OneSignal)
          
          # Notification Channels
          NTFY_TOPIC: "murase_status_tune"
          
          # Secrets for OneSignal
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
          
        run: |
          # ---------------------------------------------------------
          # 1. Fetch Data from Gist
          # ---------------------------------------------------------
          # å¤±æ•—ã—ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ­¢ã‚ãªã„ã‚ˆã†ã« || true ã‚’ä»˜ä¸
          RESPONSE=$(curl -s "https://api.github.com/gists/$GIST_ID") || true
          
          # JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
          CONTENT=$(echo "$RESPONSE" | jq -r ".files[\"$FILE_NAME\"].content" 2>/dev/null) || true
          
          # Guard: ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—æ™‚ã¯èª¤ä½œå‹•ã‚’é˜²ããŸã‚çµ‚äº†
          if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
            echo "âš ï¸ Failed to fetch Gist data (Server Error or Network Issue). Skipping check."
            exit 0
          fi

          # ---------------------------------------------------------
          # 2. Parse Timestamp & Calculate Duration
          # ---------------------------------------------------------
          LAST_UPDATED_STR=$(echo "$CONTENT" | jq -r ".last_updated")
          CITY=$(echo "$CONTENT" | jq -r '.location.city // "ä¸æ˜ãªå ´æ‰€"')
          
          # æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ä¸æ­£ãƒã‚§ãƒƒã‚¯
          if [ -z "$LAST_UPDATED_STR" ] || [ "$LAST_UPDATED_STR" = "null" ]; then
             echo "âš ï¸ Invalid timestamp data. Skipping."
             exit 0
          fi

          LAST_UPDATED_TS=$(date -d "$LAST_UPDATED_STR" +%s)
          NOW_TS=$(date +%s)
          
          DIFF_SEC=$((NOW_TS - LAST_UPDATED_TS))
          DIFF_HOURS=$((DIFF_SEC / 3600))
          
          echo "ğŸ•’ Last Updated: $LAST_UPDATED_STR ($CITY)"
          echo "â³ Elapsed: $DIFF_HOURS hours"

          # ---------------------------------------------------------
          # 3. Logic Branching (Status Check)
          # ---------------------------------------------------------
          
          # Case A: Critical (Over 72h) -> OneSignal to ALL Users
          # 72æ™‚é–“ã‚’è¶…ãˆãŸã‚‰ã€å³åº§ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é€šçŸ¥
          if [ "$DIFF_HOURS" -ge "$CRITICAL_HOURS" ]; then
            echo "ğŸš¨ Status: CRITICAL (Over $CRITICAL_HOURS h). Sending OneSignal to ALL..."
            
            TITLE="æœ€å¾Œã®æ›´æ–°ã‹ã‚‰72æ™‚é–“ãŒçµŒã¡ã¾ã—ãŸ"
            MESSAGE="æœ€å¾Œã«æ›´æ–°ã•ã‚ŒãŸã®ã¯ ${CITY} ã§ã™ã€‚"
            URL="https://status.muraseryosuke.info/"
            ICON="https://status.muraseryosuke.info/gameover_face.png"
            
            # OneSignal API (All Users)
            curl --include \
                 --request POST \
                 --header "Content-Type: application/json; charset=utf-8" \
                 --header "Authorization: Basic $ONESIGNAL_API_KEY" \
                 --data-binary "{
                   \"app_id\": \"$ONESIGNAL_APP_ID\",
                   \"headings\": {\"en\": \"$TITLE\", \"ja\": \"$TITLE\"},
                   \"contents\": {\"en\": \"$MESSAGE\", \"ja\": \"$MESSAGE\"},
                   \"url\": \"$URL\",
                   \"large_icon\": \"$ICON\",
                   \"ios_attachments\": {\"id1\": \"$ICON\"},
                   \"included_segments\": [\"All\"]
                 }" \
                 https://onesignal.com/api/v1/notifications

          # Case B: Warning (Exactly 71h) -> ntfy.sh to Admin ONLY
          # "71æ™‚é–“ä»¥ä¸Šã€ã‹ã¤72æ™‚é–“æœªæº€" ã®1æ™‚é–“ã ã‘å‹•ä½œã™ã‚‹ç®¡ç†è€…å‘ã‘è­¦å‘Š
          elif [ "$DIFF_HOURS" -ge "$WARN_HOURS" ]; then
            echo "âš ï¸ Status: WARNING (Over $WARN_HOURS h). Sending ntfy alert to Admin..."
            
            NTFY_TITLE="âš ï¸ æ›´æ–°æœŸé™ã¾ã§ã‚ã¨1æ™‚é–“"
            NTFY_MSG="æœ€çµ‚æ›´æ–°ã‹ã‚‰71æ™‚é–“ãŒçµŒéã—ã¾ã—ãŸã€‚72æ™‚é–“ã‚’è¶…ãˆã‚‹ã¨BeaconãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚"
            NTFY_URL="https://status.muraseryosuke.info/"
            
            # ntfy.sh (Priority: urgent = æ¿€ã—ã„é€šçŸ¥éŸ³)
            curl \
              -H "Title: $NTFY_TITLE" \
              -H "Priority: urgent" \
              -H "Tags: warning,hourglass" \
              -H "Click: $NTFY_URL" \
              -d "$NTFY_MSG" \
              https://ntfy.sh/$NTFY_TOPIC

          else
            echo "âœ… Status: ALIVE (Within limits)"
          fi
