name: Watchdog Monitor

on:
  schedule:
    # Execute every hour at minute 0
    - cron: '0 * * * *'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check Vital Status & Notify
        env:
          # --- Configuration ---
          GIST_ID: "1f81b107b898201a865a613c319d579b"
          FILE_NAME: "murase_status.json"
          THRESHOLD_HOURS: 72
          # Secrets from Repository Settings
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
        run: |
          # 1. Fetch data from Gist (Suppress errors to handle gracefully later)
          RESPONSE=$(curl -s "https://api.github.com/gists/$GIST_ID") || true

          # Attempt to parse JSON content
          CONTENT=$(echo "$RESPONSE" | jq -r ".files[\"$FILE_NAME\"].content" 2>/dev/null) || true
          
          # --- Guard Clause: Fetch Failure ---
          # If content is empty or null (Server Error/Network Issue), exit cleanly.
          # We do NOT want to send a false "death" notification due to API errors.
          if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
            echo "‚ö†Ô∏è Failed to fetch Gist data (Server Error or Network Issue). Skipping check."
            exit 0
          fi

          # 2. Extract timestamp and location
          LAST_UPDATED_STR=$(echo "$CONTENT" | jq -r ".last_updated")
          CITY=$(echo "$CONTENT" | jq -r '.location.city // "‰∏çÊòé„Å™Â†¥ÊâÄ"')
          
          # Check for invalid timestamp
          if [ -z "$LAST_UPDATED_STR" ] || [ "$LAST_UPDATED_STR" = "null" ]; then
             echo "‚ö†Ô∏è Invalid timestamp data. Skipping."
             exit 0
          fi

          echo "Last Updated: $LAST_UPDATED_STR"
          echo "Last Location: $CITY"
          
          # 3. Calculate elapsed time
          LAST_UPDATED_TS=$(date -d "$LAST_UPDATED_STR" +%s)
          NOW_TS=$(date +%s)
          
          DIFF_SEC=$((NOW_TS - LAST_UPDATED_TS))
          DIFF_HOURS=$((DIFF_SEC / 3600))
          
          echo "Elapsed Hours: $DIFF_HOURS (Threshold: $THRESHOLD_HOURS)"
          
          # 4. Check Status & Notify
          if [ "$DIFF_HOURS" -ge "$THRESHOLD_HOURS" ]; then
            echo "üö® Status: UNKNOWN (Over $THRESHOLD_HOURS h). Sending Notification..."
            
            # Notification Payload
            TITLE="ÊúÄÂæå„ÅÆÊõ¥Êñ∞„Åã„Çâ72ÊôÇÈñì„ÅåÁµå„Å°„Åæ„Åó„Åü"
            MESSAGE="ÊúÄÂæå„Å´Êõ¥Êñ∞„Åï„Çå„Åü„ÅÆ„ÅØ ${CITY} „Åß„Åô„ÄÇ"
            URL="https://status.muraseryosuke.info/"
            ICON="https://status.muraseryosuke.info/gameover_face.png"
            
            # Send to OneSignal API
            curl --include \
                 --request POST \
                 --header "Content-Type: application/json; charset=utf-8" \
                 --header "Authorization: Basic $ONESIGNAL_API_KEY" \
                 --data-binary "{
                   \"app_id\": \"$ONESIGNAL_APP_ID\",
                   \"headings\": {\"en\": \"$TITLE\", \"ja\": \"$TITLE\"},
                   \"contents\": {\"en\": \"$MESSAGE\", \"ja\": \"$MESSAGE\"},
                   \"url\": \"$URL\",
                   \"large_icon\": \"$ICON\",
                   \"ios_attachments\": {\"id1\": \"$ICON\"},
                   \"included_segments\": [\"All\"]
                 }" \
                 https://onesignal.com/api/v1/notifications
                 
          else
            echo "‚úÖ Status: ALIVE (Within limits)"
          fi
