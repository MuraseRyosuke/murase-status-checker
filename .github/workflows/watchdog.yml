name: Watchdog Monitor

on:
  schedule:
    # 1æ™‚é–“ã«1å›ã€æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
    - cron: '0 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚‚æœ‰åŠ¹åŒ–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check Vital Status & Notify
        env:
          # --- è¨­å®š ---
          GIST_ID: "1f81b107b898201a865a613c319d579b"
          FILE_NAME: "murase_status.json"
          THRESHOLD_HOURS: 72
          # Secretsã‹ã‚‰èª­ã¿è¾¼ã‚€éµ
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
        run: |
          # 1. Gistã‹ã‚‰æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾— (å¤±æ•—ã—ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ­¢ã‚ãªã„ã‚ˆã†ã« || true ã‚’ä»˜ä¸)
          RESPONSE=$(curl -s "https://api.github.com/gists/$GIST_ID") || true

          # JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
          # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå–ã‚Œãªã‹ã£ãŸã‚ŠJSONãŒå£Šã‚Œã¦ã„ã‚‹å ´åˆã¯ç©ºã«ãªã‚‹
          CONTENT=$(echo "$RESPONSE" | jq -r ".files[\"$FILE_NAME\"].content" 2>/dev/null) || true
          
          # --- ã€é‡è¦ã€‘èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ã‚¬ãƒ¼ãƒ‰å‡¦ç† ---
          # ãƒ‡ãƒ¼ã‚¿ãŒç©ºã€ã¾ãŸã¯ null ã®å ´åˆã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ç­‰ã®ãŸã‚
          # 72æ™‚é–“çµŒéã¨ã¯ã¿ãªã•ãšã€ä½•ã‚‚ã›ãšæ­£å¸¸çµ‚äº†(exit 0)ã™ã‚‹
          if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
            echo "âš ï¸ Failed to fetch Gist data (Server Error or Network Issue). Skipping check."
            exit 0
          fi

          # 2. æœ€çµ‚æ›´æ–°æ—¥æ™‚ã¨å ´æ‰€ã‚’æŠ½å‡º
          LAST_UPDATED_STR=$(echo "$CONTENT" | jq -r ".last_updated")
          
          # ã€ä¿®æ­£ã€‘jqå†…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤æ–‡å­—åˆ—ã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ(")ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
          # å¤–å´ã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¿ã€å†…å´ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã«ã—ã¾ã™
          CITY=$(echo "$CONTENT" | jq -r '.location.city // "ä¸æ˜ãªå ´æ‰€"')
          
          # æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ãªå ´åˆã‚‚ã‚¹ã‚­ãƒƒãƒ—
          if [ -z "$LAST_UPDATED_STR" ] || [ "$LAST_UPDATED_STR" = "null" ]; then
             echo "âš ï¸ Invalid timestamp data. Skipping."
             exit 0
          fi

          echo "Last Updated: $LAST_UPDATED_STR"
          echo "Last Location: $CITY"
          
          # 3. çµŒéæ™‚é–“ã‚’è¨ˆç®—
          # æ—¥ä»˜æ–‡å­—åˆ—ã‚’UNIXæ™‚é–“ã«å¤‰æ›ã—ã¦å·®åˆ†ã‚’å–ã‚‹
          LAST_UPDATED_TS=$(date -d "$LAST_UPDATED_STR" +%s)
          NOW_TS=$(date +%s)
          
          DIFF_SEC=$((NOW_TS - LAST_UPDATED_TS))
          DIFF_HOURS=$((DIFF_SEC / 3600))
          
          echo "Elapsed Hours: $DIFF_HOURS (Threshold: $THRESHOLD_HOURS)"
          
          # 4. åˆ¤å®š & é€šçŸ¥å®Ÿè¡Œ
          if [ "$DIFF_HOURS" -ge "$THRESHOLD_HOURS" ]; then
            echo "ğŸš¨ Status: UNKNOWN (Over $THRESHOLD_HOURS h). Sending Notification..."
            
            # é€šçŸ¥å†…å®¹
            TITLE="æœ€å¾Œã®æ›´æ–°ã‹ã‚‰72æ™‚é–“ãŒçµŒã¡ã¾ã—ãŸ"
            MESSAGE="æœ€å¾Œã«æ›´æ–°ã•ã‚ŒãŸã®ã¯ ${CITY} ã§ã™ã€‚"
            URL="https://status.muraseryosuke.info/"
            
            # OneSignal API ã¸é€ä¿¡ (curl)
            # large_icon: Androidç”¨ãƒ©ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³
            # ios_attachments: iOSç”¨æ·»ä»˜ç”»åƒï¼ˆé€šçŸ¥ã®å³å´ã«è¡¨ç¤ºï¼‰
            curl --include \
                 --request POST \
                 --header "Content-Type: application/json; charset=utf-8" \
                 --header "Authorization: Basic $ONESIGNAL_API_KEY" \
                 --data-binary "{
                   \"app_id\": \"$ONESIGNAL_APP_ID\",
                   \"headings\": {\"en\": \"$TITLE\", \"ja\": \"$TITLE\"},
                   \"contents\": {\"en\": \"$MESSAGE\", \"ja\": \"$MESSAGE\"},
                   \"url\": \"$URL\",
                   \"large_icon\": \"https://status.muraseryosuke.info/gameover_face.png\",
                   \"ios_attachments\": {\"id1\": \"https://status.muraseryosuke.info/gameover_face.png\"},
                   \"included_segments\": [\"All\"]
                 }" \
                 https://onesignal.com/api/v1/notifications
                 
          else
            echo "âœ… Status: ALIVE (Within limits)"
          fi
